<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: Decoder</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('df/d92/refDetectorsMUONMCHRawDecoder.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Decoder </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>MCH Raw Data Decoder</h1>
<p>There are currently two data formats to be dealt with : the "bare" one coming out of the CRU when no user logic (UL) is used, or the "UL" one where user logic is actually used. Each of the two formats can be used in charge sum (the sampa electronics does the charge integration) or in sample mode (the sampa electronics transmit all the charge samples). All formats are composed of {RawDataHeader,Payload} pairs.</p>
<p>Note that the cluster sum mode has to be properly selected, as there is unfortunately no way to infer it from the data itself...</p>
<h2>createDecoder&lt;FORMAT,CHARGESUM,RDH&gt;</h2>
<p>On the reading/consumer/decoding end, the choice of the decoder to use is made through a templatized function, <code>createDecoder&lt;FORMAT,CHARGESUM,RDH&gt;</code>. Currently the following template parameters combinations have been tested :</p>
<table class="doxtable">
<tr>
<th align="center">FORMAT </th><th align="center">CHARGESUM </th><th align="center">RDH  </th></tr>
<tr>
<td align="center">BareFormat </td><td align="center">ChargeSumMode </td><td align="center">RawDataHeaderV4 </td></tr>
<tr>
<td align="center">BareFormat </td><td align="center">SampleMode </td><td align="center">RawDataHeaderV4 </td></tr>
<tr>
<td align="center">UserLogicFormat </td><td align="center">ChargeSumMode </td><td align="center">RawDataHeaderV4 </td></tr>
<tr>
<td align="center">UserLogicFormat </td><td align="center">SampleMode </td><td align="center">RawDataHeaderV4 </td></tr>
</table>
<p>RDH V5 is not yet supported, but is planned.</p>
<p>As an example, to get a decoder for BareFormat in ChargeSum mode, using RawDataHeaderV4 :</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../dd/d0d/MUON_2MCH_2Raw_2Decoder_2include_2MCHRawDecoder_2Decoder_8h.html">MCHRawDecoder/Decoder.h</a>&quot;</span></div><div class="line"></div><div class="line">RawDataHeaderHandler&lt;RAWDataHeaderV4&gt; rh;</div><div class="line"><a class="code" href="../../d2/d26/namespaceo2_1_1mch_1_1raw.html#a50c96e8e6241cfd1766a9cccb0ff8396">SampaChannelHandler</a> ch;</div><div class="line"></div><div class="line"><span class="keyword">auto</span> decoder = o2::mch::raw::createDecoder&lt;BareFormat, ChargeSumMode, RAWDataHeaderV4&gt;(rh, ch);</div><div class="line"></div><div class="line"><span class="comment">// get some memory buffer from somewhere ...</span></div><div class="line"><a class="code" href="../../dc/da3/glcorearb_8h.html#a3667f558219c90437106b544a3ca00b8">buffer</a> = ... </div><div class="line"></div><div class="line"><span class="comment">// decode that buffer</span></div><div class="line">decode(buffer);</div></div><!-- fragment --><p>The <code>createDecoder</code> function requires two parameters : a <code>RawDataHeaderHandler</code> and a <code>SampaChannelHandler</code>. Both parameters can be defined as lambdas, regular free functions, or member functions of some class.</p>
<h2>RawDataHeaderHandler</h2>
<p>The <code>RawDataHeaderHandler</code> is a function that takes a RawDataHeader and (optionally) returns a RawDataHeader, i.e. :</p>
<div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="../../d2/d26/namespaceo2_1_1mch_1_1raw.html#a905618e20ed3388441bbc65c1ff993fc">RawDataHeaderHandler</a> = std::function&lt;std::optional&lt;RDH&gt;(<span class="keyword">const</span> <a class="code" href="../../d8/d47/structo2_1_1header_1_1RAWDataHeaderV4.html">RDH</a>&amp; rdh)&gt;;</div></div><!-- fragment --><p>If no RDH is returned (i.e. <code>std::nullopt</code> is returned) then that part of the raw data is <em>not</em> decoded at all. The returned RDH can be a modified version of the argument, e.g. to change some of the values (like <code>feeId</code> according to some mapping).</p>
<h2>SampaChannelHandler</h2>
<p>The <code>SampaChannelHandler</code> is also a function, that takes a dual sampa identifier (in electronics realm, aka solar,group,index tuple), a channel identifier within that dual sampa, a <code>SampaCluster</code> and returns nothing, i.e. :</p>
<blockquote class="doxtable">
<p><a class="el" href="../../d2/d88/classA.html">A</a> word of caution here about the naming. <a class="el" href="../../d2/d88/classA.html">A</a> <code>SampaCluster</code> is a group of raw data samples of <em>one</em> dual sampa channel, and has nothing to do with a cluster of pads or something alike. </p>
</blockquote>
<div class="fragment"><div class="line"><span class="keyword">using</span> <a class="code" href="../../d2/d26/namespaceo2_1_1mch_1_1raw.html#a50c96e8e6241cfd1766a9cccb0ff8396">SampaChannelHandler</a> = std::function&lt;<a class="code" href="../../dc/da3/glcorearb_8h.html#a950fc91edb4504f62f1c577bf4727c29">void</a>(DsElecId dsId,</div><div class="line">                                               uint8_t channel,</div><div class="line">                                               SampaCluster)&gt;;</div></div><!-- fragment --><p>That function is called by the raw data decoder for each <code>SampaCluster</code> that it finds in the data. <a class="el" href="../../d2/d88/classA.html">A</a> very simple example would be a function to dump the SampaClusters :</p>
<div class="fragment"><div class="line"><a class="code" href="../../d2/d26/namespaceo2_1_1mch_1_1raw.html#a50c96e8e6241cfd1766a9cccb0ff8396">SampaChannelHandler</a> <a class="code" href="../../d5/d93/testUserLogicElinkDecoder_8cxx.html#aec05af1ae95c60baf4db3d55e41c01fc">handlePacket</a>(DsElecId dsId, uint8_t channel, SampaCluster sc) {</div><div class="line">    std::cout &lt;&lt; <a class="code" href="../../dc/da3/glcorearb_8h.html#ae2d3db041c6004a67047659b42f73a44">fmt::format</a>(<span class="stringliteral">&quot;{}-ch-{}-ts-{}-q-{}&quot;</span>, <a class="code" href="../../d9/df7/ConfigurableParamHelper_8cxx.html#a513e489498bde75117aca1622cb2eb41">asString</a>(dsId), channel, sc.timestamp, sc.chargeSum));</div><div class="line">}</div><div class="line"><span class="comment">// (note that this particular function only correctly handles the SampaCluster in ChargeSum Mode)</span></div></div><!-- fragment --><h2>TODO</h2>
<p>Add a description of the two data formats here ? </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d0/d2f/refDetectors.html">Module &#39;Detectors&#39;</a></li><li class="navelem"><a class="el" href="../../d4/dff/refDetectorsMUON.html">MUON</a></li><li class="navelem"><a class="el" href="../../d0/daf/refDetectorsMUONMCH.html">MCH</a></li><li class="navelem"><a class="el" href="../../d4/dea/refDetectorsMUONMCHRaw.html">Raw CoDec</a></li>
    <li class="footer">Generated on Wed Feb 19 2020 20:08:32 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
